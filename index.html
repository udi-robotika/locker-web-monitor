<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8" />
  <title>Locker Monitor ESP02/ESP01</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      direction: rtl;
      margin: 20px;
    }
    .status {
      margin-bottom: 10px;
    }
    .status span {
      font-weight: bold;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      margin-top: 10px;
      cursor: pointer;
    }
    .online {
      color: green;
      font-weight: bold;
    }
    .offline {
      color: red;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>לוקר – חיווי ופתיחה</h1>

  <div class="status">
    סטטוס MQTT: <span id="mqttStatus" class="offline">מנסה להתחבר...</span>
  </div>

  <div class="status">
    סטטוס לוקר (Heartbeat): <span id="lockerOnline" class="offline">לא ידוע</span>
  </div>

  <div class="status">
    מצב דלת: <span id="doorState">לא ידוע</span>
  </div>

  <div class="status">
    לוקר נוכחי: <span id="lockerId"></span>
  </div>

  <button id="openBtn">פתח לוקר (1500ms)</button>

  <script>
    // ===== הגדרות MQTT – להתאים ל-EMQX שלך =====
    const MQTT_HOST = "j78ab272.ala.eu-central-1.emqxsl.com"; // כמו בקוד ESP
    const MQTT_PORT = 8084;  // WebSocket TLS port (לבדוק ב-EMQX)
    const MQTT_PATH = "/mqtt";

    const MQTT_USER = "udi";       // כמו ב-ESP או יוזר ייעודי לדפדפן
    const MQTT_PASS = "ABCD1414";  // שים לב שזה חשוף – עדיף יוזר עם הרשאות מוגבלות

    // תבחר איזה ESP אתה רוצה לנטר/לשלוט – ESP01 או ESP02
    const ESP_ID   = "ESP01";  // למשל
    const BOX_ID   = "1";

    const TOPIC_CMD       = `esp/${ESP_ID}/box/${BOX_ID}/cmd`;
    const TOPIC_HEARTBEAT = `esp/${ESP_ID}/heartbeat`;
    const TOPIC_DOORSTATE = `esp/${ESP_ID}/box/${BOX_ID}/state`;

    // ===== DOM elements =====
    const mqttStatusEl   = document.getElementById("mqttStatus");
    const lockerOnlineEl = document.getElementById("lockerOnline");
    const doorStateEl    = document.getElementById("doorState");
    const openBtn        = document.getElementById("openBtn");
    const lockerIdEl     = document.getElementById("lockerId");

    lockerIdEl.textContent = `${ESP_ID} / box ${BOX_ID}`;

    // ===== MQTT client =====
    const clientId = "web-monitor-" + Math.random().toString(16).substr(2, 8);
    const connectUrl = `wss://${MQTT_HOST}:${MQTT_PORT}${MQTT_PATH}`;

    const client = mqtt.connect(connectUrl, {
      clientId: clientId,
      username: MQTT_USER,
      password: MQTT_PASS,
      clean: true,
      reconnectPeriod: 2000
    });

    // נשמור זמן אחרון של heartbeat כדי לדעת אם הלוקר "חי"
    let lastHeartbeatTime = null;

    client.on("connect", () => {
      console.log("MQTT connected");
      mqttStatusEl.textContent = "מחובר";
      mqttStatusEl.className = "online";

      client.subscribe(TOPIC_HEARTBEAT, (err) => {
        if (!err) console.log("Subscribed to heartbeat:", TOPIC_HEARTBEAT);
      });

      client.subscribe(TOPIC_DOORSTATE, (err) => {
        if (!err) console.log("Subscribed to door state:", TOPIC_DOORSTATE);
      });
    });

    client.on("reconnect", () => {
      console.log("MQTT reconnecting...");
      mqttStatusEl.textContent = "מנסה להתחבר...";
      mqttStatusEl.className = "offline";
    });

    client.on("error", (err) => {
      console.error("MQTT error:", err);
      mqttStatusEl.textContent = "שגיאה בחיבור";
      mqttStatusEl.className = "offline";
    });

    client.on("close", () => {
      console.log("MQTT connection closed");
      mqttStatusEl.textContent = "מנותק";
      mqttStatusEl.className = "offline";
    });

    client.on("message", (topic, message) => {
      const msg = message.toString();
      console.log("MQTT message:", topic, msg);

      if (topic === TOPIC_HEARTBEAT) {
        // ה-ESP שולח "ONLINE" כל 30 שניות
        lastHeartbeatTime = Date.now();
        lockerOnlineEl.textContent = "מחובר";
        lockerOnlineEl.className = "online";
      } else if (topic === TOPIC_DOORSTATE) {
        // מצפה ל-JSON: {"doorOpen":true/false}
        try {
          const obj = JSON.parse(msg);
          if (obj.doorOpen === true) {
            doorStateEl.textContent = "פתוחה";
          } else if (obj.doorOpen === false) {
            doorStateEl.textContent = "סגורה";
          } else {
            doorStateEl.textContent = msg;
          }
        } catch (e) {
          console.warn("Bad JSON in door state:", msg);
          doorStateEl.textContent = msg;
        }
      }
    });

    // ===== כפתור פתיחת לוקר =====
    openBtn.addEventListener("click", () => {
      if (!client.connected) {
        alert("לא מחובר ל-MQTT");
        return;
      }
      const payload = "OPEN:1500";
      client.publish(TOPIC_CMD, payload);
      console.log("Sent:", TOPIC_CMD, payload);
    });

    // ===== בדיקת Heartbeat – אם לא קיבלנו זמן מה, נסמן כלא-מחובר =====
    setInterval(() => {
      if (lastHeartbeatTime === null) return;

      const diff = Date.now() - lastHeartbeatTime; // מילישניות
      // אם עברו יותר מ-70 שניות מאז heartbeat אחרון – נניח שהלוקר לא מחובר
      if (diff > 70000) {
        lockerOnlineEl.textContent = "לא מחובר (אין Heartbeat)";
        lockerOnlineEl.className = "offline";
      }
    }, 5000);
  </script>
</body>
</html>
